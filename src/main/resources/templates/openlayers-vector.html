<!DOCTYPE html>
<html lang="zh-Hans-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title><th:block th:text="${tilesetName}" />Openlayers预览</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="/static/assets/openlayers/v9.2.4/ol.css" rel="stylesheet">
    <script src="/static/assets/openlayers/v9.2.4/ol.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
<div id="map"></div>
<script th:inline="javascript">
    const metaData = [[${metaData}]];
    const basePath = [[${basePath}]];
    const tiles = basePath + "/api/tilesets/" + [[${tilesetName}]] + "/{z}/{x}/{-y}." + metaData.format;

    //默认Style
    var styles = new ol.style.Style({
        // stroke: new ol.style.Stroke({
        //     color: 'rgba(30,144,255)',
        //     width: 3
        // }),
        fill: new ol.style.Fill({
            color: '#00263D'
        })
    })

    const vtLayer = new ol.layer.VectorTile({
        source: new ol.source.VectorTile({
            format: new ol.format.MVT({featureClass: ol.Feature}),
            url: tiles,
            tileGrid: ol.tilegrid.createXYZ({maxZoom: 13})
        }),
        style: function (feature) {
            if (feature.values_.layer === "place") {

            } else if (feature.values_.layer === "water") {
                return new ol.style.Style({
                    fill: new ol.style.Fill({color: "#015179"}),
                })
            } else if (feature.values_.layer === "water_name") {

            } else if (feature.values_.layer === "landcover") {
                return new ol.style.Style({
                    fill: new ol.style.Fill({color: "#43ad7f"}),
                })
            } else if (feature.values_.layer === "boundary") {
                return new ol.style.Style({
                    fill: new ol.style.Fill({color: "#4e98f4"}),
                    stroke: new ol.style.Stroke({
                        width: 1,
                        color: "#06789D"
                    })
                })
            } else {
                console.log(feature)
            }
        }
    });

    const map = new ol.Map({
        target: 'map',
        view: new ol.View({
            center: [0, 0],
            zoom: 2
        }),
        layers: [vtLayer]
    });

    const vSource = new ol.source.Vector();
    const featuresForZ = [];
    let viewZ = vtLayer.getSource().getTileGrid().getZForResolution(map.getView().getResolution());

    function vsRefresh() {
        vSource.clear();
        if (featuresForZ[viewZ]) {
            vSource.addFeatures(featuresForZ[viewZ]);
        }
    }

    vtLayer.getSource().on('tileloadend', function (evt) {
        var z = evt.tile.getTileCoord()[0];
        var features = evt.tile.getFeatures();
        features.forEach(function (feature) {
            // each vector tile has its own set of feature ids, but duplicates are not allowed in normal vector sources
            feature.setId(undefined);
        });
        if (!Array.isArray(featuresForZ[z])) {
            featuresForZ[z] = [];
        }
        featuresForZ[z] = featuresForZ[z].concat(features);
        if (z === viewZ) {
            vsRefresh();
        }
    });

    map.getView().on('change:resolution', function () {
        // use VT features from the tile z level corresponding to view resolution
        var newZ = vtLayer.getSource().getTileGrid().getZForResolution(map.getView().getResolution());
        if (newZ !== viewZ) {
            viewZ = newZ;
            vsRefresh();
        }
    });

    const vLayer = new ol.layer.Vector({
        source: vSource,
        style: styles
    });
    map.addLayer(vLayer);
</script>
</body>

</html>